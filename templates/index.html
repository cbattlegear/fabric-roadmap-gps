<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric GPS - Microsoft Fabric Roadmap Tracker</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 style="margin: 0; font-size: 1.5rem; color: var(--fabric-neutral-grey-160);">
                üó∫Ô∏è Fabric GPS
            </h1>
        </div>
    </header>

    <main>
        <section class="hero-section">
            <div class="container">
                <h1 class="hero-title">Microsoft Fabric Roadmap Tracker</h1>
                <p class="hero-subtitle">
                    Stay up-to-date with the latest Microsoft Fabric roadmap updates.
                    Get real-time feeds and explore what's coming next.
                </p>
            </div>
        </section>

        <div class="container">
            <section class="card-grid">
                <div class="card">
                    <h2 class="card-title">üì° RSS Feed</h2>
                    <p class="card-description">
                        Subscribe to our RSS feed to get the latest roadmap updates delivered directly to your feed reader.
                        Perfect for staying informed about new features and release dates.
                    </p>
                    <a href="/rss" class="button button-primary">View RSS Feed</a>
                    <a href="/rss.xml" class="button button-secondary" style="margin-left: 0.5rem;">Download XML</a>
                </div>

                <div class="card">
                    <h2 class="card-title">üîå JSON API</h2>
                    <p class="card-description">
                        Access structured roadmap data through our REST API. Filter by product, release type, status,
                        or recent changes. Perfect for integrations and custom applications.
                    </p>
                    <a href="/api/releases" class="button button-primary">Explore API</a>
                    <a href="/endpoints" class="button button-secondary" style="margin-left: 0.5rem;">Documentation</a>
                </div>

                <div class="card">
                    <h2 class="card-title">üìä Data Insights</h2>
                    <p class="card-description">
                        Our system tracks changes across all Microsoft Fabric products, providing you with
                        comprehensive coverage of the roadmap landscape with 24-hour caching for optimal performance.
                    </p>
                    <a href="/endpoints" class="button button-primary">View Details</a>
                </div>
            </section>

            <section class="recent-changes-section">
                <h2 class="section-title">Recent Changes</h2>
                <div class="recent-changes-content">
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="product-filter">Product:</label>
                            <select id="product-filter" class="filter-select">
                                <option value="">All Products</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="type-filter">Release Type:</label>
                            <select id="type-filter" class="filter-select">
                                <option value="">All Types</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="status-filter">Status:</label>
                            <select id="status-filter" class="filter-select">
                                <option value="">All Statuses</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="days-filter">Modified Within:</label>
                            <select id="days-filter" class="filter-select">
                                <option value="">All Time</option>
                                <option value="7">Last 7 days</option>
                                <option value="14">Last 14 days</option>
                                <option value="30">Last 30 days</option>
                            </select>
                        </div>
                        <button id="apply-filters" class="button button-primary">Apply Filters</button>
                        <button id="clear-filters" class="button button-secondary">Clear</button>
                    </div>
                    
                    <div class="loading-indicator" id="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <span>Loading recent changes...</span>
                    </div>
                    
                    <div class="changes-grid" id="changes-grid">
                        <!-- Changes will be populated by JavaScript -->
                    </div>
                    
                    <div class="no-results" id="no-results" style="display: none;">
                        <p>No changes found matching your filters. Try adjusting your criteria.</p>
                    </div>
                </div>
            </section>

            <section class="features-section">
                <div class="why-build-section">
                    <h2 class="section-title">Why Build Fabric GPS?</h2>
                    <div class="why-build-content">
                        <div class="why-build-story">
                            <p class="story-text">
                                After several people in the span of a week asked for an easier way to track changes across the Microsoft Fabric roadmap,
                                we built Fabric GPS to provide a simple and efficient solution.
                            </p>
                            <p class="story-text">
                                Our goal is to make it easier for everyone to stay informed about the latest developments in the Microsoft Fabric ecosystem.
                            </p>
                        </div>
                        <div class="benefits-grid">
                            <div class="benefit-item">
                                <div class="benefit-icon">üéØ</div>
                                <h4>Focused Updates</h4>
                                <p>Get only the roadmap changes that matter to you with smart filtering.</p>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">‚ö°</div>
                                <h4>Real-time Data</h4>
                                <p>Stay current with 24-hour refresh cycles and instant notifications.</p>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">üîß</div>
                                <h4>Developer Friendly</h4>
                                <p>RESTful APIs and RSS feeds for easy integration into your workflow.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="coming-soon-section">
                    <h3 class="coming-soon-title">Coming Soon</h3>
                    <div class="roadmap-items">
                        <div class="roadmap-item subscription-item">
                            <div class="roadmap-icon">üì®</div>
                            <div class="roadmap-content">
                                <h4>Weekly Email Updates</h4>
                                <p>Get a weekly summary of Microsoft Fabric roadmap changes delivered to your inbox.</p>
                                <div class="subscription-form">
                                    <input type="email" id="subscription-email" placeholder="Enter your email" class="subscription-input" />
                                    <button id="subscribe-btn" class="button button-secondary subscription-btn">Subscribe</button>
                                </div>
                                <div id="subscription-message" class="subscription-message" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="roadmap-item">
                            <div class="roadmap-icon">üìà</div>
                            <div class="roadmap-content">
                                <h4>Analytics Dashboard</h4>
                                <p>Visualize roadmap trends and track update frequency across different product areas.</p>
                                <span class="roadmap-status">Planned</span>
                            </div>
                        </div>
                        <div class="roadmap-item">
                            <div class="roadmap-icon">üîî</div>
                            <div class="roadmap-content">
                                <h4>Custom Alerts</h4>
                                <p>Set up personalized alerts for specific products, features, or release types.</p>
                                <span class="roadmap-status">Research</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Fabric GPS. Data sourced from Microsoft Fabric Roadmap. Updated every 24 hours.</p>
        </div>
    </footer>

    <script>
        // Recent Changes functionality
        class RecentChanges {
            constructor() {
                this.filterOptions = {};
                this.currentData = [];
                this.init();
            }

            async init() {
                await this.loadFilterOptions();
                await this.loadRecentChanges();
                this.bindEvents();
            }

            async loadFilterOptions() {
                try {
                    const response = await fetch('/api/filter-options');
                    this.filterOptions = await response.json();
                    this.populateFilterSelects();
                } catch (error) {
                    console.error('Error loading filter options:', error);
                }
            }

            populateFilterSelects() {
                const productSelect = document.getElementById('product-filter');
                const typeSelect = document.getElementById('type-filter');
                const statusSelect = document.getElementById('status-filter');

                // Populate product names
                this.filterOptions.product_names.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });

                // Populate release types
                this.filterOptions.release_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });

                // Populate release statuses
                this.filterOptions.release_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                });
            }

            async loadRecentChanges(filters = {}) {
                this.showLoading(true);
                try {
                    const params = new URLSearchParams();
                    if (filters.product_name) params.append('product_name', filters.product_name);
                    if (filters.release_type) params.append('release_type', filters.release_type);
                    if (filters.release_status) params.append('release_status', filters.release_status);
                    if (filters.modified_within_days) params.append('modified_within_days', filters.modified_within_days);

                    const response = await fetch(`/api/releases?${params.toString()}`);
                    this.currentData = await response.json();
                    
                    // Limit to 15 items and sort by last_modified
                    this.currentData.sort((a, b) => new Date(b.last_modified) - new Date(a.last_modified));
                    this.currentData = this.currentData.slice(0, 15);
                    
                    this.renderChanges();
                } catch (error) {
                    console.error('Error loading recent changes:', error);
                    this.showError();
                } finally {
                    this.showLoading(false);
                }
            }

            renderChanges() {
                const container = document.getElementById('changes-grid');
                const noResults = document.getElementById('no-results');

                if (this.currentData.length === 0) {
                    container.innerHTML = '';
                    noResults.style.display = 'block';
                    return;
                }

                noResults.style.display = 'none';
                container.innerHTML = this.currentData.map(item => this.createChangeItem(item)).join('');
            }

            createChangeItem(item) {
                const date = new Date(item.last_modified).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const releaseDate = item.release_date ? new Date(item.release_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : 'TBD';

                return `
                    <div class="change-item">
                        <div class="change-header">
                            <h3 class="change-title">${this.escapeHtml(item.feature_name || 'Unnamed Feature')}</h3>
                            <div class="change-badges">
                                <span class="change-badge badge-product">${this.escapeHtml(item.product_name || 'Unknown')}</span>
                                <span class="change-badge badge-type">${this.escapeHtml(item.release_type || 'Unknown')}</span>
                                <span class="change-badge badge-status">${this.escapeHtml(item.release_status || 'Unknown')}</span>
                            </div>
                        </div>
                        <div class="change-meta">
                            <span class="change-date">Last Modified: ${date}</span>
                            <span class="release-date">Release Date: ${releaseDate}</span>
                        </div>
                        <p class="change-description">
                            ${this.escapeHtml(item.feature_description || 'No description available.')}
                        </p>
                    </div>
                `;
            }

            bindEvents() {
                const applyBtn = document.getElementById('apply-filters');
                const clearBtn = document.getElementById('clear-filters');

                applyBtn.addEventListener('click', () => {
                    const filters = this.getActiveFilters();
                    this.loadRecentChanges(filters);
                });

                clearBtn.addEventListener('click', () => {
                    this.clearFilters();
                    this.loadRecentChanges();
                });

                // Allow Enter key to apply filters
                document.querySelectorAll('.filter-select').forEach(select => {
                    select.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const filters = this.getActiveFilters();
                            this.loadRecentChanges(filters);
                        }
                    });
                });
            }

            getActiveFilters() {
                return {
                    product_name: document.getElementById('product-filter').value,
                    release_type: document.getElementById('type-filter').value,
                    release_status: document.getElementById('status-filter').value,
                    modified_within_days: document.getElementById('days-filter').value
                };
            }

            clearFilters() {
                document.getElementById('product-filter').value = '';
                document.getElementById('type-filter').value = '';
                document.getElementById('status-filter').value = '';
                document.getElementById('days-filter').value = '';
            }

            showLoading(show) {
                const loader = document.getElementById('loading-indicator');
                const grid = document.getElementById('changes-grid');
                const noResults = document.getElementById('no-results');
                
                if (show) {
                    loader.style.display = 'flex';
                    grid.style.display = 'none';
                    noResults.style.display = 'none';
                } else {
                    loader.style.display = 'none';
                    grid.style.display = 'grid';
                }
            }

            showError() {
                const container = document.getElementById('changes-grid');
                const noResults = document.getElementById('no-results');
                
                container.innerHTML = '';
                noResults.innerHTML = '<p>Error loading changes. Please try again later.</p>';
                noResults.style.display = 'block';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new RecentChanges();
            new EmailSubscription();
        });

        // Email Subscription functionality
        class EmailSubscription {
            constructor() {
                this.init();
            }

            init() {
                const subscribeBtn = document.getElementById('subscribe-btn');
                const emailInput = document.getElementById('subscription-email');
                
                if (subscribeBtn && emailInput) {
                    subscribeBtn.addEventListener('click', () => this.subscribe());
                    emailInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.subscribe();
                        }
                    });
                }
            }

            async subscribe() {
                const emailInput = document.getElementById('subscription-email');
                const subscribeBtn = document.getElementById('subscribe-btn');
                const messageDiv = document.getElementById('subscription-message');
                
                const email = emailInput.value.trim();
                
                if (!email) {
                    this.showMessage('Please enter your email address', 'error');
                    return;
                }

                if (!this.isValidEmail(email)) {
                    this.showMessage('Please enter a valid email address', 'error');
                    return;
                }

                // Disable button and show loading
                subscribeBtn.disabled = true;
                subscribeBtn.textContent = 'Subscribing...';

                try {
                    const response = await fetch('/api/subscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email: email })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.showMessage('Check your email for a verification link!', 'success');
                        emailInput.value = '';
                    } else {
                        this.showMessage(data.error || 'Failed to subscribe', 'error');
                    }
                } catch (error) {
                    console.error('Subscription error:', error);
                    this.showMessage('Network error. Please try again.', 'error');
                } finally {
                    subscribeBtn.disabled = false;
                    subscribeBtn.textContent = 'Subscribe';
                }
            }

            showMessage(text, type) {
                const messageDiv = document.getElementById('subscription-message');
                messageDiv.textContent = text;
                messageDiv.className = `subscription-message ${type}`;
                messageDiv.style.display = 'block';

                // Hide message after 5 seconds
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
        }
    </script>
</body>
</html>

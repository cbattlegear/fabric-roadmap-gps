<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric GPS - Microsoft Fabric Roadmap Tracker</title>
    <script type="text/javascript">
        !(function (cfg){function e(){cfg.onInit&&cfg.onInit(n)}var x,w,D,t,E,n,C=window,O=document,b=C.location,q="script",I="ngestionendpoint",L="disableExceptionTracking",j="ai.device.";"instrumentationKey"[x="toLowerCase"](),w="crossOrigin",D="POST",t="appInsightsSDK",E=cfg.name||"appInsights",(cfg.name||C[t])&&(C[t]=E),n=C[E]||function(g){var f=!1,m=!1,h={initialize:!0,queue:[],sv:"8",version:2,config:g};function v(e,t){var n={},i="Browser";function a(e){e=""+e;return 1===e.length?"0"+e:e}return n[j+"id"]=i[x](),n[j+"type"]=i,n["ai.operation.name"]=b&&b.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(h.sv||h.version),{time:(i=new Date).getUTCFullYear()+"-"+a(1+i.getUTCMonth())+"-"+a(i.getUTCDate())+"T"+a(i.getUTCHours())+":"+a(i.getUTCMinutes())+":"+a(i.getUTCSeconds())+"."+(i.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z",iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}},ver:undefined,seq:"1",aiDataContract:undefined}}var n,i,t,a,y=-1,T=0,S=["js.monitor.azure.com","js.cdn.applicationinsights.io","js.cdn.monitor.azure.com","js0.cdn.applicationinsights.io","js0.cdn.monitor.azure.com","js2.cdn.applicationinsights.io","js2.cdn.monitor.azure.com","az416426.vo.msecnd.net"],o=g.url||cfg.src,r=function(){return s(o,null)};function s(d,t){if((n=navigator)&&(~(n=(n.userAgent||"").toLowerCase()).indexOf("msie")||~n.indexOf("trident/"))&&~d.indexOf("ai.3")&&(d=d.replace(/(\/)(ai\.3\.)([^\d]*)$/,function(e,t,n){return t+"ai.2"+n})),!1!==cfg.cr)for(var e=0;e<S.length;e++)if(0<d.indexOf(S[e])){y=e;break}var n,i=function(e){var a,t,n,i,o,r,s,c,u,l;h.queue=[],m||(0<=y&&T+1<S.length?(a=(y+T+1)%S.length,p(d.replace(/^(.*\/\/)([\w\.]*)(\/.*)$/,function(e,t,n,i){return t+S[a]+i})),T+=1):(f=m=!0,s=d,!0!==cfg.dle&&(c=(t=function(){var e,t={},n=g.connectionString;if(n)for(var i=n.split(";"),a=0;a<i.length;a++){var o=i[a].split("=");2===o.length&&(t[o[0][x]()]=o[1])}return t}()).instrumentationkey||g.instrumentationKey||"",t=(t=(t=t[I])&&"/"===t.slice(-1)?t.slice(0,-1):t)?t+"/v2/track":g.endpointUrl,t=g.userOverrideEndpointUrl||t,(n=[]).push((i="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",o=s,u=t,(l=(r=v(c,"Exception")).data).baseType="ExceptionData",l.baseData.exceptions=[{typeName:"SDKLoadFailed",message:i.replace(/\./g,"-"),hasFullStack:!1,stack:i+"\nSnippet failed to load ["+o+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(b&&b.pathname||"_unknown_")+"\nEndpoint: "+u,parsedStack:[]}],r)),n.push((l=s,i=t,(u=(o=v(c,"Message")).data).baseType="MessageData",(r=u.baseData).message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+l+")").replace(/\"/g,"")+'"',r.properties={endpoint:i},o)),s=n,c=t,JSON&&((u=C.fetch)&&!cfg.useXhr?u(c,{method:D,body:JSON.stringify(s),mode:"cors"}):XMLHttpRequest&&((l=new XMLHttpRequest).open(D,c),l.setRequestHeader("Content-type","application/json"),l.send(JSON.stringify(s)))))))},a=function(e,t){m||setTimeout(function(){!t&&h.core||i()},500),f=!1},p=function(e){var n=O.createElement(q),e=(n.src=e,t&&(n.integrity=t),n.setAttribute("data-ai-name",E),cfg[w]);return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=a,n.onerror=i,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||a(0,t)},cfg.ld&&cfg.ld<0?O.getElementsByTagName("head")[0].appendChild(n):setTimeout(function(){O.getElementsByTagName(q)[0].parentNode.appendChild(n)},cfg.ld||0),n};p(d)}cfg.sri&&(n=o.match(/^((http[s]?:\/\/.*\/)\w+(\.\d+){1,5})\.(([\w]+\.){0,2}js)$/))&&6===n.length?(d="".concat(n[1],".integrity.json"),i="@".concat(n[4]),l=window.fetch,t=function(e){if(!e.ext||!e.ext[i]||!e.ext[i].file)throw Error("Error Loading JSON response");var t=e.ext[i].integrity||null;s(o=n[2]+e.ext[i].file,t)},l&&!cfg.useXhr?l(d,{method:"GET",mode:"cors"}).then(function(e){return e.json()["catch"](function(){return{}})}).then(t)["catch"](r):XMLHttpRequest&&((a=new XMLHttpRequest).open("GET",d),a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE)if(200===a.status)try{t(JSON.parse(a.responseText))}catch(e){r()}else r()},a.send())):o&&r();try{h.cookie=O.cookie}catch(k){}function e(e){for(;e.length;)!function(t){h[t]=function(){var e=arguments;f||h.queue.push(function(){h[t].apply(h,e)})}}(e.pop())}var c,u,l="track",d="TrackPage",p="TrackEvent",l=(e([l+"Event",l+"PageView",l+"Exception",l+"Trace",l+"DependencyData",l+"Metric",l+"PageViewPerformance","start"+d,"stop"+d,"start"+p,"stop"+p,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),h.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},(g.extensionConfig||{}).ApplicationInsightsAnalytics||{});return!0!==g[L]&&!0!==l[L]&&(e(["_"+(c="onerror")]),u=C[c],C[c]=function(e,t,n,i,a){var o=u&&u(e,t,n,i,a);return!0!==o&&h["_"+c]({message:e,url:t,lineNumber:n,columnNumber:i,error:a,evt:C.event}),o},g.autoExceptionInstrumented=!0),h}(cfg.cfg),(C[E]=n).queue&&0===n.queue.length?(n.queue.push(e),n.trackPageView({})):e();})({
        src: "https://js.monitor.azure.com/scripts/b/ai.3.gbl.min.js",
        // name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
        // ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
        // useXhr: 1, // Use XHR instead of fetch to report failures (if available),
        // dle: true, // Prevent the SDK from reporting load failure log
        crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
        // onInit: null, // Once the application insights instance has loaded and initialized this callback function will be called with 1 argument -- the sdk instance (DON'T ADD anything to the sdk.queue -- As they won't get called)
        // sri: false, // Custom optional value to specify whether fetching the snippet from integrity file and do integrity check
        cfg: { // Application Insights Configuration
            connectionString: "InstrumentationKey=abe0fd34-1a9f-4fac-adef-0a391ab5a425;IngestionEndpoint=https://canadacentral-1.in.applicationinsights.azure.com/;LiveEndpoint=https://canadacentral.livediagnostics.monitor.azure.com/;ApplicationId=63030687-a2e7-4248-8b1a-e4b9f265e1e5"
        }});
    </script>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüó∫Ô∏è%3C/text%3E%3C/svg%3E">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 style="margin: 0; font-size: 1.5rem; color: var(--fabric-neutral-grey-160);">
                üó∫Ô∏è Fabric GPS
            </h1>
        </div>
    </header>

    <main>
        <section class="hero-section">
            <div class="container">
                <h1 class="hero-title">Microsoft Fabric Roadmap Tracker</h1>
                <p class="hero-subtitle">
                    Stay up-to-date with the latest Microsoft Fabric roadmap updates.
                    Get real-time feeds and explore what's coming next.
                </p>
            </div>
        </section>

        <div class="container">
            <section class="card-grid">
                <div class="card">
                    <h2 class="card-title">üì° RSS Feed</h2>
                    <p class="card-description">
                        Subscribe to our RSS feed to get the latest roadmap updates delivered directly to your feed reader.
                        Perfect for staying informed about new features and release dates.
                    </p>
                    <a href="/rss" class="button button-primary">View RSS Feed</a>
                    <a href="/rss.xml" class="button button-secondary" style="margin-left: 0.5rem;">Download XML</a>
                </div>

                <div class="card">
                    <h2 class="card-title">üîå JSON API</h2>
                    <p class="card-description">
                        Access structured roadmap data through our REST API. Filter by product, release type, status,
                        or recent changes. Perfect for integrations and custom applications.
                    </p>
                    <a href="/api/releases" class="button button-primary">Explore API</a>
                    <a href="/endpoints" class="button button-secondary" style="margin-left: 0.5rem;">Documentation</a>
                </div>

                <div class="card">
                    <h2 class="card-title">üìä Data Insights</h2>
                    <p class="card-description">
                        Our system tracks changes across all Microsoft Fabric products, providing you with
                        comprehensive coverage of the roadmap landscape with 24-hour caching for optimal performance.
                    </p>
                    <a href="/endpoints" class="button button-primary">View Details</a>
                </div>
            </section>

            <section class="recent-changes-section">
                <h2 class="section-title">Recent Changes</h2>
                <div class="recent-changes-content">
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="product-filter">Product:</label>
                            <select id="product-filter" class="filter-select">
                                <option value="">All Products</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="type-filter">Release Type:</label>
                            <select id="type-filter" class="filter-select">
                                <option value="">All Types</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="status-filter">Status:</label>
                            <select id="status-filter" class="filter-select">
                                <option value="">All Statuses</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="days-filter">Modified Within:</label>
                            <select id="days-filter" class="filter-select">
                                <option value="">All Time</option>
                                <option value="7">Last 7 days</option>
                                <option value="14">Last 14 days</option>
                                <option value="30">Last 30 days</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="search-input">Search:</label>
                            <input id="search-input" class="filter-select" type="search" placeholder="Search features, descriptions, products..." />
                        </div>
                        <button id="apply-filters" class="button button-primary">Apply Filters</button>
                        <button id="clear-filters" class="button button-secondary">Clear</button>
                    </div>
                    
                    <div class="loading-indicator" id="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <span>Loading recent changes...</span>
                    </div>
                    
                    <div class="changes-grid" id="changes-grid">
                        <!-- Changes will be populated by JavaScript -->
                    </div>
                    
                    <div class="no-results" id="no-results" style="display: none;">
                        <p>No changes found matching your filters. Try adjusting your criteria.</p>
                    </div>
                </div>
            </section>

            <section class="features-section">
                <div class="why-build-section">
                    <h2 class="section-title">Why Build Fabric GPS?</h2>
                    <div class="why-build-content">
                        <div class="why-build-story">
                            <p class="story-text">
                                After several people in the span of a week asked for an easier way to track changes across the Microsoft Fabric roadmap,
                                we built Fabric GPS to provide a simple and efficient solution.
                            </p>
                            <p class="story-text">
                                Our goal is to make it easier for everyone to stay informed about the latest developments in the Microsoft Fabric ecosystem.
                            </p>
                        </div>
                        <div class="benefits-grid">
                            <div class="benefit-item">
                                <div class="benefit-icon">üéØ</div>
                                <h4>Focused Updates</h4>
                                <p>Get only the roadmap changes that matter to you with smart filtering.</p>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">‚ö°</div>
                                <h4>Real-time Data</h4>
                                <p>Stay current with 24-hour refresh cycles and instant notifications.</p>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">üîß</div>
                                <h4>Developer Friendly</h4>
                                <p>RESTful APIs and RSS feeds for easy integration into your workflow.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="coming-soon-section">
                    <h3 class="coming-soon-title">Coming Soon</h3>
                    <div class="roadmap-items">
                        <div class="roadmap-item">
                            <div class="roadmap-icon">üì®</div>
                            <div class="roadmap-content">
                                <h4>Email Notifications</h4>
                                <p>Get notified instantly when roadmap items change or new features are announced.</p>
                                <span class="roadmap-status">In Development</span>
                            </div>
                        </div>
                        <div class="roadmap-item">
                            <div class="roadmap-icon">üìà</div>
                            <div class="roadmap-content">
                                <h4>Analytics Dashboard</h4>
                                <p>Visualize roadmap trends and track update frequency across different product areas.</p>
                                <span class="roadmap-status">Planned</span>
                            </div>
                        </div>
                        <div class="roadmap-item">
                            <div class="roadmap-icon">üîî</div>
                            <div class="roadmap-content">
                                <h4>Custom Alerts</h4>
                                <p>Set up personalized alerts for specific products, features, or release types.</p>
                                <span class="roadmap-status">Research</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Fabric GPS. Data sourced from Microsoft Fabric Roadmap. Updated every 24 hours.</p>
        </div>
    </footer>

    <div id="release-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-backdrop" data-modal-close></div>
        <div class="modal-dialog" role="document">
            <button class="modal-close" title="Close" data-modal-close>&times;</button>
            <div id="modal-content" class="modal-content">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <script>
        class ReleaseModal {
            constructor() {
                this.modal = document.getElementById('release-modal');
                this.content = document.getElementById('modal-content');
                this.bindGlobal();
                this.checkHashOnLoad();
            }
            bindGlobal() {
                document.querySelectorAll('[data-modal-close]').forEach(el => {
                    el.addEventListener('click', () => this.hide());
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen()) this.hide();
                });
            }
            isOpen() { return this.modal.getAttribute('aria-hidden') === 'false'; }
            show() { this.modal.setAttribute('aria-hidden', 'false'); document.body.style.overflow='hidden'; }
            hide() { this.modal.setAttribute('aria-hidden', 'true'); document.body.style.overflow=''; this.clearHashIfMatches(); }
            clearHashIfMatches(){ if (location.hash.startsWith('#release/')) { history.replaceState(null,'',location.pathname+location.search); } }
            async openById(id) {
                try {
                    const r = await fetch(`/api/releases?release_item_id=${encodeURIComponent(id)}`);
                    if (!r.ok){ this.renderError(`Item not found (${id})`); return; }
                    const data = await r.json();
                    this.renderItemShell(data); // initial render without history
                    this.show();
                    if(!location.hash.includes(id)) { history.replaceState(null,'',`#release/${id}`); }
                    // Fetch history (non-blocking)
                    this.loadHistory(id);
                } catch(err){ this.renderError('Error loading item'); }
            }
            renderItemShell(item){
                const relDate = item.release_date ? new Date(item.release_date).toLocaleDateString() : 'TBD';
                const lm = item.last_modified ? new Date(item.last_modified).toLocaleDateString() : 'Unknown';
                const typeClass = item.release_type === 'General availability' ? 'success' : 'warn';
                const statusClass = item.release_status === 'Shipped' ? 'success' : 'warn';
                this.content.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title">${this.escape(item.feature_name || 'Unnamed Feature')}</h2>
                        <span class="modal-last-modified">Last Modified: ${this.escape(lm)}</span>
                        <div class="modal-meta">
                            <span class="modal-badge">${this.escape(item.product_name || 'Unknown Product')}</span>
                            <span class="modal-badge ${typeClass}">${this.escape(item.release_type || 'Unknown Type')}</span>
                            <span class="modal-badge ${statusClass}">${this.escape(item.release_status || 'Unknown Status')}</span>
                            <span class="modal-badge">Release: ${this.escape(relDate)}</span>
                        </div>
                    </div>
                    <div class="modal-section">
                        <h4>Description</h4>
                        <div class="modal-description">${this.escape(item.feature_description || 'No description provided.')}</div>
                    </div>
                    <div class="modal-section" id="history-section">
                        <h4>Change History</h4>
                        <div class="history-loading" style="font-size:.8rem; opacity:.7;">Loading history...</div>
                        <ol class="history-timeline" style="list-style:none; padding:0; margin: .5rem 0 0 0;"></ol>
                    </div>
                    <div class="modal-actions">
                        <button class="link-copy" data-copy-link>Copy Direct Link</button>
                        <a class="button button-secondary" href="/api/releases?release_item_id=${encodeURIComponent(item.release_item_id)}" target="_blank" rel="noopener">Open API JSON</a>
                    </div>
                `;
                this.bindCopy(item.release_item_id);
            }
            bindCopy(id){
                const copyBtn = this.content.querySelector('[data-copy-link]');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        const link = `${location.origin}${location.pathname}#release/${id}`;
                        navigator.clipboard.writeText(link).then(()=>{
                            const old = copyBtn.textContent; copyBtn.textContent='Link Copied'; setTimeout(()=>copyBtn.textContent=old,1500);
                        });
                    });
                }
            }
            async loadHistory(id){
                try {
                    const r = await fetch(`/api/releases/history/${encodeURIComponent(id)}`);
                    if(!r.ok){ this.renderHistoryError('History unavailable'); return; }
                    const hist = await r.json();
                    this.renderHistory(hist);
                } catch(err){ this.renderHistoryError('History error'); }
            }
            renderHistory(hist){
                const section = this.content.querySelector('#history-section');
                if(!section) return;
                const loading = section.querySelector('.history-loading');
                if (loading) loading.remove();
                const list = section.querySelector('.history-timeline');
                if(!hist || hist.length === 0){
                    list.innerHTML = '<li style="font-size:.8rem; opacity:.7;">No history entries.</li>';
                    return;
                }
                list.innerHTML = hist.map(h => {
                    const lm = h.last_modified ? new Date(h.last_modified).toLocaleDateString() : 'Unknown';
                    const changes = (h.changed_columns && h.changed_columns.length) ? h.changed_columns.map(c=>`<code style="background:var(--fabric-neutral-grey-20); padding:2px 4px; border-radius:3px;">${this.escape(c)}</code>`).join(' ') : '<span style="opacity:.6;">(no column list)</span>';
                    return `<li style="margin: .5rem 0; line-height:1.4;">
                        <div style="font-size:.7rem; letter-spacing:.05em; text-transform:uppercase; color:var(--fabric-neutral-grey-90);">${this.escape(lm)}</div>
                        <div class="history-changes" style="margin-top:2px; font-size:.75rem;">${changes}</div>
                    </li>`;
                }).join('');
            }
            renderHistoryError(msg){
                const section = this.content.querySelector('#history-section');
                if(!section) return;
                const loading = section.querySelector('.history-loading');
                if (loading) loading.textContent = msg;
            }
            escape(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
            checkHashOnLoad(){ if (location.hash.startsWith('#release/')) { const id = location.hash.split('#release/')[1]; if (id) this.openById(id); } }
        }

        // Extend RecentChanges to open modal on item click
        class RecentChanges {
            constructor() {
                this.filterOptions = {};
                this.currentData = [];
                this.debounceTimer = null;
                this.minSearchLength = 2; // minimum chars to trigger search
                this.init();
            }

            async init() {
                await this.loadFilterOptions();
                await this.loadRecentChanges();
                this.bindEvents();
            }

            async loadFilterOptions() {
                try {
                    const response = await fetch('/api/filter-options');
                    this.filterOptions = await response.json();
                    this.populateFilterSelects();
                } catch (error) {
                    console.error('Error loading filter options:', error);
                }
            }

            populateFilterSelects() {
                const productSelect = document.getElementById('product-filter');
                const typeSelect = document.getElementById('type-filter');
                const statusSelect = document.getElementById('status-filter');

                // Populate product names
                this.filterOptions.product_names.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });

                // Populate release types
                this.filterOptions.release_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });

                // Populate release statuses
                this.filterOptions.release_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                });
            }

            async loadRecentChanges(filters = {}) {
                this.showLoading(true);
                try {
                    const params = new URLSearchParams();
                    if (filters.product_name) params.append('product_name', filters.product_name);
                    if (filters.release_type) params.append('release_type', filters.release_type);
                    if (filters.release_status) params.append('release_status', filters.release_status);
                    if (filters.modified_within_days) params.append('modified_within_days', filters.modified_within_days);
                    // Include search query if meets minimum length
                    if (filters.q && String(filters.q).trim().length >= this.minSearchLength) {
                        params.append('q', String(filters.q).trim());
                    }

                    const response = await fetch(`/api/releases?${params.toString()}`);
                    this.currentData = await response.json();
                    
                    // Limit to 15 items and sort by last_modified
                    this.currentData.sort((a, b) => new Date(b.last_modified) - new Date(a.last_modified));
                    this.currentData = this.currentData.slice(0, 15);
                    
                    this.renderChanges();
                } catch (error) {
                    console.error('Error loading recent changes:', error);
                    this.showError();
                } finally {
                    this.showLoading(false);
                }
            }

            renderChanges() {
                const container = document.getElementById('changes-grid');
                const noResults = document.getElementById('no-results');

                if (this.currentData.length === 0) {
                    container.innerHTML = '';
                    noResults.style.display = 'block';
                    return;
                }

                noResults.style.display = 'none';
                container.innerHTML = this.currentData.map(item => this.createChangeItem(item)).join('');
                // Attach click handlers
                container.querySelectorAll('.change-item').forEach(card => {
                    card.addEventListener('click', () => {
                        const id = card.getAttribute('data-id');
                        window.__releaseModal.openById(id);
                    });
                });
            }

            createChangeItem(item) {
                const date = new Date(item.last_modified).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const releaseDate = item.release_date ? new Date(item.release_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : 'TBD';

                const releaseTypeClass = item.release_type == 'General availability' ? 'badge-success' : 'badge-warning';
                const releaseStatusClass = item.release_status == 'Shipped' ? 'badge-success' : 'badge-warning';

                return `
                    <div class="change-item" data-id="${this.escapeHtml(item.release_item_id)}" role="button" tabindex="0" aria-label="View details for ${this.escapeHtml(item.feature_name || 'feature')}">
                        <div class="change-header">
                            <h3 class="change-title">${this.escapeHtml(item.feature_name || 'Unnamed Feature')}</h3>
                            <div class="change-badges">
                                <span class="change-badge badge-product">${this.escapeHtml(item.product_name || 'Unknown')}</span>
                                <span class="change-badge ${releaseTypeClass}">${this.escapeHtml(item.release_type || 'Unknown')}</span>
                                <span class="change-badge ${releaseStatusClass}">${this.escapeHtml(item.release_status || 'Unknown')}</span>
                            </div>
                        </div>
                        <div class="change-meta">
                            <span class="change-date">Last Modified: ${date}</span>
                            <span class="release-date">Release Date: ${releaseDate}</span>
                        </div>
                        <p class="change-description">${this.escapeHtml(item.feature_description || 'No description available.')}</p>
                        <div class="change-link-inline" style="margin-top:.5rem; font-size:.75rem; color: var(--fabric-primary);">Click for details ‚ñ∏</div>
                    </div>`;
            }
            bindEvents() {
                const applyBtn = document.getElementById('apply-filters');
                const clearBtn = document.getElementById('clear-filters');

                // Debounced search input handling
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.debounceSearch();
                    });
                }

                applyBtn.addEventListener('click', () => {
                    const filters = this.getActiveFilters();
                    this.loadRecentChanges(filters);
                });

                clearBtn.addEventListener('click', () => {
                    this.clearFilters();
                    this.loadRecentChanges();
                });

                // Allow Enter key to apply filters
                document.querySelectorAll('.filter-select').forEach(select => {
                    select.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const filters = this.getActiveFilters();
                            this.loadRecentChanges(filters);
                        }
                    });
                });
            }

            getActiveFilters() {
                return {
                    product_name: document.getElementById('product-filter').value,
                    release_type: document.getElementById('type-filter').value,
                    release_status: document.getElementById('status-filter').value,
                    modified_within_days: document.getElementById('days-filter').value,
                    q: (document.getElementById('search-input') && document.getElementById('search-input').value) || ''
                };
            }

            clearFilters() {
                document.getElementById('product-filter').value = '';
                document.getElementById('type-filter').value = '';
                document.getElementById('status-filter').value = '';
                document.getElementById('days-filter').value = '';
                const si = document.getElementById('search-input');
                if (si) si.value = '';
            }

            showLoading(show) {
                const loader = document.getElementById('loading-indicator');
                const grid = document.getElementById('changes-grid');
                const noResults = document.getElementById('no-results');
                
                if (show) {
                    loader.style.display = 'flex';
                    grid.style.display = 'none';
                    noResults.style.display = 'none';
                } else {
                    loader.style.display = 'none';
                    grid.style.display = 'grid';
                }
            }

            showError() {
                const container = document.getElementById('changes-grid');
                const noResults = document.getElementById('no-results');
                
                container.innerHTML = '';
                noResults.innerHTML = '<p>Error loading changes. Please try again later.</p>';
                noResults.style.display = 'block';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            debounceSearch(delay = 300) {
                if (this.debounceTimer) clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    const filters = this.getActiveFilters();
                    // If search text is too short and non-empty, don't send 'q' param (acts like no-search)
                    if (filters.q && String(filters.q).trim().length > 0 && String(filters.q).trim().length < this.minSearchLength) {
                        // do not search yet
                        return;
                    }
                    this.loadRecentChanges(filters);
                }, delay);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.__releaseModal = new ReleaseModal();
            new RecentChanges();
        });
    </script>
</body>
</html>
